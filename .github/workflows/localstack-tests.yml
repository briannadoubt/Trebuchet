name: LocalStack Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  localstack-integration:
    name: AWS Integration Tests with LocalStack
    runs-on: ubuntu-latest

    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
          - 4571:4571
        env:
          SERVICES: lambda,dynamodb,dynamodbstreams,servicediscovery,iam,apigatewayv2
          DEBUG: 1
          AWS_DEFAULT_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          PERSISTENCE: 0
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:4566/_localstack/health; do sleep 2; done'
          echo "LocalStack is ready!"

      - name: Initialize LocalStack resources
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
        run: |
          # Install AWS CLI
          pip install awscli-local[ver1]

          # Run init scripts
          chmod +x Tests/TrebuchetAWSTests/localstack-init/*.sh

          # Create tables
          bash Tests/TrebuchetAWSTests/localstack-init/01-setup-tables.sh

          # Create IAM roles
          bash Tests/TrebuchetAWSTests/localstack-init/02-setup-iam.sh

          # Verify resources
          awslocal --endpoint-url=http://localhost:4566 dynamodb list-tables
          awslocal --endpoint-url=http://localhost:4566 servicediscovery list-namespaces

      - name: Build
        run: swift build --build-tests

      - name: Run integration tests
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
        run: |
          swift test --filter TrebuchetAWSTests

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: .build/debug/*.xctestresult
