import Foundation

/// Generates Lambda bootstrap code for discovered actors
public struct BootstrapGenerator {
    public init() {}

    /// Generate a Lambda bootstrap for the given configuration
    /// - Parameters:
    ///   - config: Resolved configuration
    ///   - actors: Discovered actor metadata
    /// - Returns: Swift source code for the bootstrap
    public func generate(config: ResolvedConfig, actors: [ActorMetadata]) -> String {
        let imports = generateImports(actors: actors)
        let actorInitializations = generateActorInitializations(actors: actors)
        let actorRegistrations = generateActorRegistrations(actors: actors)

        return """
        // ============================================================================
        // AUTO-GENERATED FILE - DO NOT EDIT
        // Generated by trebuchet CLI for project: \(config.projectName)
        // ============================================================================

        \(imports)

        @main
        struct LambdaBootstrap: LambdaHandler {
            typealias Event = APIGatewayV2Request
            typealias Output = APIGatewayV2Response

            private let gateway: CloudGateway
            private let logger: Logger

            init(context: LambdaInitializationContext) async throws {
                self.logger = context.logger

                // Load configuration from environment
                let config = LambdaConfiguration.fromEnvironment()

                // Initialize AWS services
                let stateStore = DynamoDBStateStore(tableName: config.stateTable)
                let registry = CloudMapRegistry(
                    namespace: config.namespace,
                    region: config.region
                )

                // Create gateway
                gateway = CloudGateway(configuration: .init(
                    host: "0.0.0.0",
                    port: 8080,
                    stateStore: stateStore,
                    registry: registry
                ))

                // Initialize and register actors
        \(actorInitializations)
        \(actorRegistrations)

                logger.info("Bootstrap initialized with \\(config.actorCount) actors")
            }

            func handle(_ event: Event, context: LambdaContext) async throws -> Output {
                return try await LambdaEventAdapter.handle(event: event, gateway: gateway, logger: logger)
            }
        }

        // MARK: - Configuration

        struct LambdaConfiguration {
            let stateTable: String
            let namespace: String
            let region: String
            let actorCount: Int

            static func fromEnvironment() -> LambdaConfiguration {
                LambdaConfiguration(
                    stateTable: ProcessInfo.processInfo.environment["STATE_TABLE"] ?? "\(config.stateTableName)",
                    namespace: ProcessInfo.processInfo.environment["NAMESPACE"] ?? "\(config.discoveryNamespace)",
                    region: ProcessInfo.processInfo.environment["AWS_REGION"] ?? "\(config.region)",
                    actorCount: \(actors.count)
                )
            }
        }

        // MARK: - Lambda Event Adapter

        enum LambdaEventAdapter {
            static func handle(
                event: APIGatewayV2Request,
                gateway: CloudGateway,
                logger: Logger
            ) async throws -> APIGatewayV2Response {
                // Health check endpoint
                if event.rawPath == "/health" {
                    return APIGatewayV2Response(
                        statusCode: .ok,
                        headers: ["Content-Type": "application/json"],
                        body: "{\\"status\\": \\"healthy\\"}"
                    )
                }

                // Parse invocation envelope
                guard let body = event.body else {
                    return errorResponse(statusCode: .badRequest, message: "Missing request body")
                }

                guard let data = body.data(using: .utf8) else {
                    return errorResponse(statusCode: .badRequest, message: "Invalid request encoding")
                }

                do {
                    let envelope = try JSONDecoder().decode(InvocationEnvelope.self, from: data)
                    logger.debug("Processing invocation for actor: \\(envelope.actorID)")

                    let response = try await processInvocation(envelope, gateway: gateway)

                    let responseData = try JSONEncoder().encode(response)
                    return APIGatewayV2Response(
                        statusCode: response.isSuccess ? .ok : .internalServerError,
                        headers: ["Content-Type": "application/json"],
                        body: String(data: responseData, encoding: .utf8) ?? "{}"
                    )
                } catch let error as DecodingError {
                    logger.error("Failed to decode invocation: \\(error)")
                    return errorResponse(statusCode: .badRequest, message: "Invalid invocation format: \\(error)")
                } catch {
                    logger.error("Invocation failed: \\(error)")
                    return errorResponse(statusCode: .internalServerError, message: "\\(error)")
                }
            }

            private static func processInvocation(
                _ envelope: InvocationEnvelope,
                gateway: CloudGateway
            ) async throws -> ResponseEnvelope {
                // The gateway handles routing to the correct actor
                // This uses the existing executeDistributedTarget machinery
                return await gateway.process(envelope)
            }

            private static func errorResponse(statusCode: HTTPResponseStatus, message: String) -> APIGatewayV2Response {
                APIGatewayV2Response(
                    statusCode: statusCode,
                    headers: ["Content-Type": "application/json"],
                    body: "{\\"error\\": \\"\\(message)\\"}"
                )
            }
        }
        """
    }

    // MARK: - Public Helpers

    /// Generate actor initialization code
    /// - Parameters:
    ///   - actors: Discovered actors
    ///   - indent: Indentation level (spaces)
    ///   - systemVariable: Name of the actor system variable (default: "gateway.system")
    /// - Returns: Swift code to initialize actors
    public static func generateActorInitializations(
        actors: [ActorMetadata],
        indent: Int = 8,
        systemVariable: String = "gateway.system"
    ) -> String {
        var lines: [String] = []
        let indentation = String(repeating: " ", count: indent)

        for actor in actors {
            let varName = actor.name.lowercased()
            lines.append("\(indentation)let \(varName) = \(actor.name)(actorSystem: \(systemVariable))")
        }

        return lines.joined(separator: "\n")
    }

    /// Generate actor registration code
    /// - Parameters:
    ///   - actors: Discovered actors
    ///   - indent: Indentation level (spaces)
    ///   - logStatement: Optional log statement format (use %ACTOR% placeholder)
    /// - Returns: Swift code to register actors with the gateway
    public static func generateActorRegistrations(
        actors: [ActorMetadata],
        indent: Int = 8,
        logStatement: String? = nil
    ) -> String {
        var lines: [String] = []
        let indentation = String(repeating: " ", count: indent)

        for actor in actors {
            let varName = actor.name.lowercased()
            let actorID = actor.name.lowercased()
            lines.append("\(indentation)try await gateway.expose(\(varName), as: \"\(actorID)\")")

            if let logFormat = logStatement {
                let log = logFormat.replacingOccurrences(of: "%ACTOR%", with: actor.name)
                lines.append("\(indentation)\(log)")
            }
        }

        return lines.joined(separator: "\n")
    }

    // MARK: - Private

    private func generateImports(actors: [ActorMetadata]) -> String {
        """
        import Foundation
        import Logging
        import Trebuchet
        import TrebuchetCloud
        import TrebuchetAWS
        import AWSLambdaRuntime
        import AWSLambdaEvents
        """
    }

    private func generateActorInitializations(actors: [ActorMetadata]) -> String {
        Self.generateActorInitializations(actors: actors, indent: 8, systemVariable: "gateway.system")
    }

    private func generateActorRegistrations(actors: [ActorMetadata]) -> String {
        Self.generateActorRegistrations(
            actors: actors,
            indent: 8,
            logStatement: #"logger.info("Registered actor: %ACTOR%")"#
        )
    }

    /// Generate a Package.swift for the Lambda target
    public func generatePackageSwift(config: ResolvedConfig) -> String {
        """
        // swift-tools-version: 6.0
        // Lambda bootstrap package for \(config.projectName)

        import PackageDescription

        let package = Package(
            name: "\(config.projectName)-lambda",
            platforms: [.macOS(.v14)],
            dependencies: [
                .package(url: "https://github.com/swift-server/swift-aws-lambda-runtime.git", from: "1.0.0"),
                .package(url: "https://github.com/swift-server/swift-aws-lambda-events.git", from: "0.4.0"),
                .package(url: "https://github.com/soto-project/soto.git", from: "7.0.0"),
                .package(path: "../.."),  // Main project
            ],
            targets: [
                .executableTarget(
                    name: "Bootstrap",
                    dependencies: [
                        .product(name: "AWSLambdaRuntime", package: "swift-aws-lambda-runtime"),
                        .product(name: "AWSLambdaEvents", package: "swift-aws-lambda-events"),
                        .product(name: "SotoDynamoDB", package: "soto"),
                        .product(name: "SotoServiceDiscovery", package: "soto"),
                        "Trebuchet",
                        "TrebuchetCloud",
                        "TrebuchetAWS",
                    ]
                ),
            ]
        )
        """
    }
}
